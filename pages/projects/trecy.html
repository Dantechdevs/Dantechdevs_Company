

    <!DOCTYPE html>
    <html lang="en" data-bs-theme="dark">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>Trecyn Netwoks ltd</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <style type="text/css">@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:300;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:400;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:500;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:600;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:700;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/greek/wght/normal.woff2);unicode-range:U+0370-03FF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/greek-ext/wght/normal.woff2);unicode-range:U+1F00-1FFF;font-display:swap;}@font-face {font-family:Inter;font-style:normal;font-weight:800;src:url(/cf-fonts/v/inter/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}</style>
        <!-- Bootstrap CSS -->
        <link href="../assets/css/bootstrap.min.css" rel="stylesheet">
        <!-- Bootstrap Icons -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
        <!-- Font Awesome -->
        <link href="../assets/css/all.min.css" rel="stylesheet">
        <!-- SweetAlert2 -->
        <script src="../assets/js/sweetalert2.min.js"></script>
        <link href="../assets/css/sweetalert2.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../assets/css/meakingwlan.css">

        <style>

            @keyframes pulse-highlight {
                0%, 100% {
                    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
                }
                50% {
                    box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
                }
            }

            .pulse-animation {
                animation: pulse-highlight 1s infinite;
            }

            /* Manual Payment Section Animations */
            #manual-payment-section {
                animation: slideInUp 0.5s ease-out;
            }

            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Pulse animation for verify button when enabled */
            #verify-manual-payment-btn:not(:disabled) {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%, 100% {
                    box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.7);
                }
                50% {
                    box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb), 0);
                }
            }

            /* Progress bar custom styling */
            .progress-bar-animated {
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            }

            /* Success voucher code highlight */
            #manual-voucher-code {
                font-size: 1.25rem;
                letter-spacing: 2px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .package-card-jiundie {
                background: linear-gradient(135deg, rgba(0, 168, 232, 0.1), rgba(0, 119, 182, 0.1));
                border: 2px solid #00A8E8;
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
            }

            .package-card-jiundie:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(0, 168, 232, 0.3);
                border-color: #0077B6;
            }

            #tv_details {
                transition: all 0.3s ease;
            }

            #tv_details:not(.d-none) {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* Force visibility for TV Only mode */
            body [id="tv_details"] {
                display: block;
            }
        </style>
    </head>

    <body>

        <div class="container-fluid">
            <!-- Theme Toggle -->
            <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <i class="bi bi-moon-fill" id="theme-icon"></i>
            </div>

            <!-- Alert Messages -->
            
            <div id="landing" class="active">
                <!-- Compact Hero Section -->
                <div class="row justify-content-center py-3">
                    <div class="col-lg-10">
                        <div class="text-center fade-in-up mb-4">
                            <h1 class="hero-title mb-2">
                                Trecyn Netwoks ltd                            </h1>
                            <p class="hero-slogan">
                                Fast,No downtime and Reliable internet at your reach                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                                    <div class="glass-card p-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h5 class="mb-0"><i class="bi bi-info-circle-fill me-2"></i>Quick Start Guide</h5>
                            <div class="d-flex gap-2">
                                <a href="/tv-guide.html" target="_blank" class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-tv me-1"></i>TV MAC Guide
                                </a>
                                <a href="/tutorial.html" target="_blank" class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-play-circle me-1"></i>Tutorial
                                </a>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-between text-center">
                            <div class="flex-fill">
                                <div class="step-number-small">1</div>
                                <small class="text-muted">Select Package</small>
                            </div>
                            <i class="bi bi-arrow-right text-muted mx-2"></i>
                            <div class="flex-fill">
                                <div class="step-number-small">2</div>
                                <small class="text-muted">Enter Phone</small>
                            </div>
                            <i class="bi bi-arrow-right text-muted mx-2"></i>
                            <div class="flex-fill">
                                <div class="step-number-small">3</div>
                                <small class="text-muted">Pay M-Pesa</small>
                            </div>
                            <i class="bi bi-arrow-right text-muted mx-2"></i>
                            <div class="flex-fill">
                                <div class="step-number-small">4</div>
                                <small class="text-muted">Connect!</small>
                            </div>
                        </div>
                    </div>
                            </div>

            <!-- Processing Screen -->
            <div id="processing" class="processing-screen hidden">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-6">
                            <h2 class="mb-4"><i class="bi bi-rocket-takeoff me-2"></i>Processing Payment</h2>
                            <p class="lead">Please complete the M-Pesa transaction on your phone</p>
                            <div class="timer-display">
                                <i class="bi bi-clock me-2"></i>Time remaining: <span id="timer">30</span> seconds
                            </div>
                            <div class="wifi-loader">
                                <span class="wifi-bar"></span>
                                <span class="wifi-bar"></span>
                                <span class="wifi-bar"></span>
                                <span class="wifi-bar"></span>
                            </div>
                            <p class="text-muted mt-4">
                                <i class="bi bi-shield-check me-2"></i>Stay on this page while we verify your payment
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center mb-3">
                <div class="col-lg-10">
                    <div class="glass-card p-3">
                        <div class="text-center">
                            <h6 class="mb-3"><i class="bi bi-tag me-2"></i>What are you paying for?</h6>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="service_type" id="service_phone" value="phone" checked>
                                <label class="btn btn-outline-primary" for="service_phone">
                                    <i class="bi bi-phone me-2"></i>Phone WiFi
                                </label>

                                
                                <input type="radio" class="btn-check" name="service_type" id="service_tv" value="tv_only">
                                <label class="btn btn-outline-info position-relative" for="service_tv">
                                    <i class="bi bi-tv me-2"></i>TV Only
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                        New
                                    </span>
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2" id="service-hint">
                                Pay for your phone internet access
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Compact WiFi Packages -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <h5 class="text-center mb-3">
                        <i class="bi bi-wifi me-2"></i>Select Your Package
                    </h5>
                    <div id="packages-container" class="packages-grid">
                        <div class="col-12 text-center">
                            <div class="wifi-loader">
                                <span class="wifi-bar"></span>
                                <span class="wifi-bar"></span>
                                <span class="wifi-bar"></span>
                                <span class="wifi-bar"></span>
                            </div>
                            <p class="text-muted">Loading packages...</p>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Action Tabs -->
            <div class="row justify-content-center mb-5">
                <div class="col-lg-8">
                    <div class="glass-card fade-in-up">
                        <!-- Tab Header with Login By indicator -->
                        <div class="text-center mb-3">
                            <h5 class="mb-2">
                                <i class="bi bi-key me-2"></i>Login Methods Available
                            </h5>
                            <p class="text-muted small">Choose your preferred login method below</p>
                        </div>

                        <ul class="nav nav-pills nav-justified mb-4" id="actionTabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#reconnect">
                                    <i class="bi bi-arrow-repeat me-2"></i>
                                    <span class="d-none d-sm-inline">Reconnect</span>
                                    <span class="d-sm-none">Reconnect</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#voucher">
                                    <i class="bi bi-ticket-perforated me-2"></i>
                                    <span class="d-none d-sm-inline">Voucher</span>
                                    <span class="d-sm-none">Voucher</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#username-tab">
                                    <i class="bi bi-person-circle me-2"></i>
                                    <span class="d-none d-sm-inline">Username</span>
                                    <span class="d-sm-none">User</span>
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <!-- Reconnect Tab -->
                            <div class="tab-pane fade show active" id="reconnect">
                                <div class="text-center mb-4">
                                    <div class="login-method-header">
                                        <i class="bi bi-arrow-repeat text-primary" style="font-size: 2rem;"></i>
                                        <h5 class="mt-2">Reconnect to WiFi</h5>
                                        <p class="text-muted">Already paid? Enter your M-Pesa Transaction ID (e.g., TF60TK7R9I) or voucher (e.g. 9AT0SVEDV480) to reconnect instantly</p>
                                    </div>
                                </div>
                                <form id="reconnectForm" action="../reis/reconnect.php" method="post">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <div class="form-floating">
                                                <input type="text" name="transaction_id" class="form-control" id="transactionId"
                                                    placeholder="Transaction ID / Voucher / Username" required
                                                    minlength="4" maxlength="20">
                                                <label for="transactionId">Transaction ID | Voucher</label>
                                            </div>
                                            <input type="hidden" name="client_ip" value="12.10.0.192">
                                            <input type="hidden" name="client_mac" value="9E:85:77:2C:D6:5D">
                                            <input type="hidden" name="service_type" id="service_type_input" value="phone">
                                            <input type="hidden" name="router_id" value="01e66aaac163fa9e7f4201d0991ee61a">
                                        </div>
                                        <div class="col-md-4">
                                            <button type="submit" class="btn btn-gradient w-100 h-100">
                                                <i class="bi bi-wifi me-2"></i>Reconnect
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Voucher Tab -->
                            <div class="tab-pane fade" id="voucher">
                                <div class="text-center mb-4">
                                    <div class="login-method-header">
                                        <i class="bi bi-ticket-perforated text-success" style="font-size: 2rem;"></i>
                                        <h5 class="mt-2">Voucher Login</h5>
                                        <p class="text-muted">Have a voucher code? Enter it below to access WiFi instantly</p>
                                    </div>
                                </div>
                                <form id="voucherForm">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <div class="form-floating">
                                                <input type="text" id="voucher_code" name="voucher_code"
                                                    class="form-control" placeholder="Voucher Code"
                                                    required maxlength="20" autocomplete="off">
                                                <label for="voucher_code">Voucher Code</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="submit" class="btn btn-gradient w-100 h-100" id="connectBtn">
                                                <i class="bi bi-wifi me-2"></i>Connect
                                            </button>
                                        </div>
                                    </div>
                                    <div id="loading" class="text-center mt-3 d-none">
                                        <div class="wifi-loader">
                                            <span class="wifi-bar"></span>
                                            <span class="wifi-bar"></span>
                                            <span class="wifi-bar"></span>
                                            <span class="wifi-bar"></span>
                                        </div>
                                        <p class="text-muted">Validating voucher...</p>
                                    </div>
                                </form>
                            </div>

                            <!-- Username/Password Tab -->
                            <div class="tab-pane fade" id="username-tab">
                                <div class="text-center mb-4">
                                    <div class="login-method-header">
                                        <i class="bi bi-person-circle text-info" style="font-size: 2rem;"></i>
                                        <h5 class="mt-2">Username Login</h5>
                                        <p class="text-muted">Login with your provided username and password</p>
                                    </div>
                                </div>
                                <form id="usernameForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="text" id="username" name="username"
                                                    class="form-control" placeholder="Username"
                                                    required autocomplete="off">
                                                <label for="username">Username</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="password" id="password" name="password"
                                                    class="form-control" placeholder="Password"
                                                    required autocomplete="off">
                                                <label for="password">Password</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-gradient w-100" id="loginBtn">
                                                <i class="bi bi-box-arrow-in-right me-2"></i>Connect to WiFi
                                            </button>
                                        </div>
                                    </div>
                                    <div id="usernameLoading" class="text-center mt-3 d-none">
                                        <div class="wifi-loader">
                                            <span class="wifi-bar"></span>
                                            <span class="wifi-bar"></span>
                                            <span class="wifi-bar"></span>
                                            <span class="wifi-bar"></span>
                                        </div>
                                        <p class="text-muted">Authenticating...</p>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="text-center py-4 fade-in-up">
                <div class="mb-3">
                    <a href="tel:+254705060294"
                        class="contact-icon" title="Call Us">
                        <i class="bi bi-telephone-fill"></i>
                    </a>
                    <a href="https://wa.me/0705060294"
                        class="contact-icon" title="WhatsApp">
                        <i class="bi bi-whatsapp"></i>
                    </a>
                </div>
                <p class="text-muted mb-0">
                    Â© 2025 Management | Trecyn Netwoks ltd                </p>
            </footer>
        </div>

        <!-- Payment Modal -->
        <div class="modal fade" id="stkModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title">
                            <i class="bi bi-phone me-2"></i>Enter Phone Number
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="stkForm">
                            <div class="mb-3">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" name="phone_number" class="form-control"
                                    placeholder="07xxxxxxxx or 2547xxxxxxxx" required>
                            </div>

                            <!-- TV ONLY GADDEMIT -->
                            <div class="mb-3 d-none" id="tv_only_mac_section">
                                <label class="form-label">
                                    <i class="bi bi-tv me-2"></i>TV MAC Address (Required for TV Only)
                                </label>
                                <input type="text" name="tv_only_mac_address" id="tv_only_mac_input" class="form-control"
                                    placeholder="12:34:56:78:9A:BC"
                                    pattern="^[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}$"
                                    title="MAC address format: 12:34:56:78:9A:BC">
                                <div class="form-text">
                                    <a href="/tv-guide.html" target="_blank">How to find TV MAC address</a>
                                </div>
                            </div>

                            <!-- TV hybrid Option -->
                            <div class="mb-3" id="hybrid_tv_section">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="tv_enabled"
                                        name="tv_enabled" onchange="toggleTVSection()">
                                    <label class="form-check-label" for="tv_enabled">
                                        Include Smart TV Access (+KES <span id="tv_price">0</span>)
                                    </label>
                                </div>
                                <div id="tv_details" class="mt-3 d-none">
                                    <label class="form-label">TV MAC Address</label>
                                    <input type="text" name="tv_mac_address" id="tv_mac_input" class="form-control"
                                        placeholder="12:34:56:78:9A:BC"
                                        pattern="^[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}$"
                                        title="MAC address format: 12:34:56:78:9A:BC">
                                    <div class="form-text">
                                        <a href="/tv-guide.html" target="_blank">How to find TV MAC address</a>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" name="amount" id="selectedAmount">
                            <input type="hidden" name="duration" id="selectedDuration">
                            <input type="hidden" name="client_ip" value="12.10.0.192">
                            <input type="hidden" name="client_mac" value="9E:85:77:2C:D6:5D">

                            <button type="submit" class="btn btn-gradient w-100">
                                <i class="bi bi-credit-card me-2"></i>Confirm Payment
                            </button>

                            <div id="paymentLoader" class="text-center mt-3 d-none">
                                <div class="wifi-loader">
                                    <span class="wifi-bar"></span>
                                    <span class="wifi-bar"></span>
                                    <span class="wifi-bar"></span>
                                    <span class="wifi-bar"></span>
                                </div>
                                <p class="text-muted">Processing payment...</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>
        </div>

        <!-- Bootstrap JS -->
        <script src="../assets/js/bootstrap.bundle.min.js"></script>

        <script>
            var tenantUuid = '5d2615ec-6083-4c5e-9438-b0ab8b65a9c2';


            // === JIUNDIE BUNDLES: Real-time calculation ===
                        // Theme management
            function toggleTheme() {
                const html = document.documentElement;
                const icon = document.getElementById('theme-icon');
                const currentTheme = html.getAttribute('data-bs-theme');

                if (currentTheme === 'dark') {
                    html.setAttribute('data-bs-theme', 'light');
                    icon.className = 'bi bi-sun-fill';
                    localStorage.setItem('theme', 'light');
                } else {
                    html.setAttribute('data-bs-theme', 'dark');
                    icon.className = 'bi bi-moon-fill';
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Load saved theme
            document.addEventListener('DOMContentLoaded', function() {

                const tvMacInput = document.querySelector('input[name="tv_mac_address"]');

                if (tvMacInput) {
                    tvMacInput.addEventListener('input', function(e) {
                        const cursorPosition = e.target.selectionStart;
                        const oldValue = e.target.value;
                        const newValue = formatMacAddress(e.target.value);

                        e.target.value = newValue;

                        // Adjust cursor position after formatting
                        let newCursorPosition = cursorPosition;
                        if (newValue.length > oldValue.length && cursorPosition > 0) {
                            // A colon was added
                            newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
                        }

                        e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                    });

                    // Validate on blur
                    tvMacInput.addEventListener('blur', function(e) {
                        const value = e.target.value;
                        if (value && !validateMacAddress(value)) {
                            e.target.style.borderColor = '#dc3545';
                            e.target.setCustomValidity('Please enter a valid MAC address (e.g., 12:34:56:78:9A:BC)');
                        } else {
                            e.target.style.borderColor = '';
                            e.target.setCustomValidity('');
                        }
                    });

                    // Allow paste formatting
                    tvMacInput.addEventListener('paste', function(e) {
                        setTimeout(() => {
                            e.target.value = formatMacAddress(e.target.value);
                        }, 10);
                    });
                }

                handleServiceTypeChange();

                const collapseToggle = document.querySelector('[data-bs-toggle="collapse"]');
                const chevronIcon = document.getElementById('chevron-icon');
                const collapseElement = document.getElementById('howToConnect');

                if (collapseToggle && collapseElement) {
                    collapseToggle.addEventListener('click', function(e) {
                        e.preventDefault();

                        // Toggle Bootstrap collapse
                        const bsCollapse = new bootstrap.Collapse(collapseElement, {
                            toggle: false
                        });

                        if (collapseElement.classList.contains('show')) {
                            bsCollapse.hide();
                            if (chevronIcon) {
                                chevronIcon.classList.remove('transition-transform');
                            }
                        } else {
                            bsCollapse.show();
                            if (chevronIcon) {
                                chevronIcon.classList.add('transition-transform');
                            }
                        }
                    });

                    // Listen for Bootstrap collapse events
                    collapseElement.addEventListener('shown.bs.collapse', function() {
                        if (chevronIcon) chevronIcon.classList.add('transition-transform');
                    });

                    collapseElement.addEventListener('hidden.bs.collapse', function() {
                        if (chevronIcon) chevronIcon.classList.remove('transition-transform');
                    });
                }


                const savedTheme = localStorage.getItem('theme') || 'dark';
                const icon = document.getElementById('theme-icon');

                document.documentElement.setAttribute('data-bs-theme', savedTheme);
                icon.className = savedTheme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';

                initializeApp();
            });
            // Browser capability detection
            var browserSupport = {
                fetch: typeof fetch !== 'undefined',
                promise: typeof Promise !== 'undefined',
                async: (function() {
                    try {
                        return (async () => {})().constructor === (async function() {}).constructor;
                    } catch (e) {
                        return false;
                    }
                })(),
                intersectionObserver: typeof IntersectionObserver !== 'undefined',
                localStorage: (function() {
                    try {
                        var test = 'test';
                        localStorage.setItem(test, test);
                        localStorage.removeItem(test);
                        return true;
                    } catch (e) {
                        return false;
                    }
                })()
            };

            // Polyfills for older browsers
            if (!browserSupport.fetch) {
                // Simple fetch polyfill using XMLHttpRequest
                window.fetch = function(url, options) {
                    return new Promise(function(resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        var method = (options && options.method) || 'GET';
                        var body = (options && options.body) || null;
                        var headers = (options && options.headers) || {};

                        xhr.open(method, url, true);

                        for (var key in headers) {
                            xhr.setRequestHeader(key, headers[key]);
                        }

                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    resolve({
                                        ok: true,
                                        status: xhr.status,
                                        text: function() {
                                            return Promise.resolve(xhr.responseText);
                                        },
                                        json: function() {
                                            return Promise.resolve(JSON.parse(xhr.responseText));
                                        }
                                    });
                                } else {
                                    reject(new Error('Network response was not ok'));
                                }
                            }
                        };

                        xhr.onerror = function() {
                            reject(new Error('Network error'));
                        };

                        xhr.send(body);
                    });
                };
            }

            // Enhanced SweetAlert fallback for older devices
            function showAlert(title, text, icon, callback) {
                if (typeof Swal !== 'undefined' && Swal.fire) {
                    try {
                        Swal.fire({
                            title: title,
                            text: text,
                            icon: icon,
                            confirmButtonText: 'OK',
                            background: '#1a1a2e',
                            color: '#fff',
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(function(result) {
                            if (callback && typeof callback === 'function') {
                                callback(result);
                            }
                        });
                    } catch (e) {
                        // Fallback to native alert
                        alert(title + '\n\n' + text);
                        if (callback && typeof callback === 'function') {
                            callback({
                                isConfirmed: true
                            });
                        }
                    }
                } else {
                    // Native alert fallback
                    alert(title + '\n\n' + text);
                    if (callback && typeof callback === 'function') {
                        callback({
                            isConfirmed: true
                        });
                    }
                }
            }

            // Enhanced loading function with fallback
            function showLoading(title, text) {
                if (typeof Swal !== 'undefined' && Swal.fire) {
                    try {
                        Swal.fire({
                            title: title,
                            text: text,
                            allowOutsideClick: false,
                            background: '#1a1a2e',
                            color: '#fff',
                            didOpen: function() {
                                if (Swal.showLoading) {
                                    Swal.showLoading();
                                }
                            }
                        });
                    } catch (e) {
                        //console.log('Loading: ' + title + ' - ' + text);
                    }
                } else {
                    //console.log('Loading: ' + title + ' - ' + text);
                }
            }

            // Safe local storage functions
            function safeSetItem(key, value) {
                if (browserSupport.localStorage) {
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (e) {
                        //console.log('Storage failed:', e);
                        return false;
                    }
                }
                return false;
            }

            function safeGetItem(key) {
                if (browserSupport.localStorage) {
                    try {
                        return localStorage.getItem(key);
                    } catch (e) {
                        // console.log('Storage retrieval failed:', e);
                        return null;
                    }
                }
                return null;
            }

            function safeRemoveItem(key) {
                if (browserSupport.localStorage) {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (e) {
                        //console.log('Storage removal failed:', e);
                        return false;
                    }
                }
                return false;
            }

            // Enhanced DOM ready function
            function domReady(callback) {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', callback);
                } else {
                    callback();
                }
            }

            // Enhanced initialization
            domReady(function() {

                // Detect if in captive portal WebView and attempt to parse URL parameters
                if (!safeGetItem('client_ip') || !safeGetItem('client_mac')) {
                    var urlParams = new URLSearchParams(window.location.search);
                    var ipFromUrl = urlParams.get('ip') || '';
                    var macFromUrl = urlParams.get('mac') || '';
                    var routerFromUrl = urlParams.get('router_id') || '';

                    if (ipFromUrl) safeSetItem('client_ip', ipFromUrl);
                    if (macFromUrl) safeSetItem('client_mac', macFromUrl);
                    if (routerFromUrl) safeSetItem('router_id', routerFromUrl);
                }
                // Enhanced animation observer with fallback
                if (browserSupport.intersectionObserver) {
                    var observerOptions = {
                        threshold: 0.1,
                        rootMargin: '0px 0px -50px 0px'
                    };

                    var observer = new IntersectionObserver(function(entries) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting) {
                                entry.target.style.animationDelay = (Math.random() * 0.3) + 's';
                                entry.target.classList.add('fade-in-up');
                            }
                        });
                    }, observerOptions);

                    var fadeElements = document.querySelectorAll('.fade-in-up');
                    for (var i = 0; i < fadeElements.length; i++) {
                        observer.observe(fadeElements[i]);
                    }
                } else {
                    // Fallback: Just add the animation class immediately
                    var fadeElements = document.querySelectorAll('.fade-in-up');
                    for (var i = 0; i < fadeElements.length; i++) {
                        fadeElements[i].classList.add('fade-in-up');
                    }
                }

                // Initialize other components
                initializePackageSystem();
                initializeForms();
            });

            //  package creation
            function createPackageCard(pkg) {
                return `
                <div class="package-card-mini" 
                     data-value="${pkg.price}" 
                     data-slogan="${pkg.slogan_name}" 
                     data-duration="${pkg.duration_formatted.display}"
                     onclick="selectPackage(this)">
                    <div class="slogan-badge">${pkg.slogan_name}</div>
                    <div class="package-info">
                        <div class="price">KSH ${pkg.price}</div>
                        <div class="duration">${pkg.duration_formatted.display}</div>
                    </div>
                    <button class="select-btn">Select</button>
                </div>
            `;
            }

            let currentServiceType = 'phone'; // Default to phone

            // Add this function to handle service type switching
            function handleServiceTypeChange() {
                const phoneRadio = document.getElementById('service_phone');
                const tvRadio = document.getElementById('service_tv');
                const hintText = document.getElementById('service-hint');

                // Set initial service type based on checked radio
                if (tvRadio && tvRadio.checked) {
                    currentServiceType = 'tv_only';
                } else {
                    currentServiceType = 'phone';
                }

                document.querySelectorAll('input[name="service_type"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        currentServiceType = this.value;

                        if (this.value === 'tv_only') {
                            hintText.textContent = 'Pay for Smart TV access only (no phone connection)';
                            hintText.style.color = '#28a745';
                        } else {
                            hintText.textContent = 'Pay for your phone internet access';
                            hintText.style.color = '';
                        }

                        //  console.log('Service type changed to:', currentServiceType); // Debug log
                    });
                });
            }

            function selectPackage(card) {
                const amount = card.getAttribute('data-value');
                const duration = card.getAttribute('data-duration');

                document.getElementById('selectedAmount').value = amount;
                document.getElementById('selectedDuration').value = duration;
                document.getElementById('selectedAmount').setAttribute('data-base-price', amount);

                // Get current service type
                const tvOnlyRadio = document.getElementById('service_tv');
                const phoneRadio = document.getElementById('service_phone');

                if (tvOnlyRadio && tvOnlyRadio.checked) {
                    currentServiceType = 'tv_only';
                } else if (phoneRadio && phoneRadio.checked) {
                    currentServiceType = 'phone';
                }

                //   console.log('Opening modal with service type:', currentServiceType);

                // Get UI elements
                const hybridSection = document.getElementById('hybrid_tv_section');
                const tvOnlySection = document.getElementById('tv_only_mac_section');
                const tvOnlyInput = document.getElementById('tv_only_mac_input');
                const hybridTvInput = document.getElementById('tv_mac_input');

                if (currentServiceType === 'tv_only') {
                    // TV Only Mode: Show dedicated TV MAC field
                    //   console.log('Setting up TV Only mode');

                    // Hide hybrid section, show TV Only section
                    hybridSection.classList.add('d-none');
                    tvOnlySection.classList.remove('d-none');

                    // Make TV Only input required
                    tvOnlyInput.required = true;
                    tvOnlyInput.disabled = false;
                    hybridTvInput.required = false;
                    hybridTvInput.value = '';

                    // Update modal title
                    document.querySelector('#stkModal .modal-title').innerHTML =
                        '<i class="bi bi-tv me-2"></i>TV Only Payment - Enter Phone & TV MAC';
                } else {
                    // Phone WiFi Mode: Show hybrid section
                    //    console.log('Setting up Phone WiFi mode');

                    // Show hybrid section, hide TV Only section
                    hybridSection.classList.remove('d-none');
                    tvOnlySection.classList.add('d-none');

                    // Reset hybrid inputs
                    document.getElementById('tv_enabled').checked = false;
                    document.getElementById('tv_details').classList.add('d-none');
                    tvOnlyInput.required = false;
                    tvOnlyInput.value = '';
                    hybridTvInput.required = false;
                    hybridTvInput.value = '';

                    // Reset modal title
                    document.querySelector('#stkModal .modal-title').innerHTML =
                        '<i class="bi bi-phone me-2"></i>Enter Phone Number';
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('stkModal'));
                modal.show();

                // Update price display after modal is shown
                setTimeout(() => {
                    updateTotalPrice();
                }, 150);
            }

            // Reset modal when closed
            document.getElementById('stkModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('stkForm').reset();

                const hybridSection = document.getElementById('hybrid_tv_section');
                const tvOnlySection = document.getElementById('tv_only_mac_section');
                const tvOnlyInput = document.getElementById('tv_only_mac_input');
                const hybridTvInput = document.getElementById('tv_mac_input');

                if (currentServiceType === 'tv_only') {
                    hybridSection.classList.add('d-none');
                    tvOnlySection.classList.remove('d-none');
                    tvOnlyInput.required = true;
                } else {
                    hybridSection.classList.remove('d-none');
                    tvOnlySection.classList.add('d-none');
                    tvOnlyInput.required = false;
                    hybridTvInput.required = false;
                }
            });

            // Enhanced router status fetching with better error handling
            function fetchPackages() {
                const routerId = getCurrentRouterId();
                const container = document.getElementById('packages-container');

                if (!routerId) {
                    container.innerHTML = `
                    <div class="col-12">
                        <div class="glass-card text-center">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            <h4 class="mt-3">No Router Selected</h4>
                            <p class="text-muted">Please refresh the page.</p>
                        </div>
                    </div>
                `;
                    return;
                }

                fetch('get_packages.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            tenant_id: 130,
                            router_id: routerId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' && data.packages.length > 0) {
                            container.innerHTML = '';
                            data.packages.forEach(pkg => {
                                container.innerHTML += createPackageCard(pkg);
                            });
                        } else {
                            container.innerHTML = `
                        <div class="col-12">
                            <div class="glass-card text-center">
                                <i class="bi bi-box text-info" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">No Packages Available</h4>
                                <p class="text-muted">No packages configured for this router.</p>
                            </div>
                        </div>
                    `;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        container.innerHTML = `
                    <div class="col-12">
                        <div class="glass-card text-center">
                            <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                            <h4 class="mt-3">Error Loading Packages</h4>
                            <p class="text-muted">Please refresh the page.</p>
                        </div>
                    </div>
                `;
                    });
            }

            // Enhanced package card listeners
            function attachPackageCardListeners() {
                var packageCards = document.querySelectorAll('.package-card');
                for (var i = 0; i < packageCards.length; i++) {
                    packageCards[i].removeEventListener('click', handlePackageCardClick);
                    packageCards[i].addEventListener('click', handlePackageCardClick);
                }
            }

            let gatewayStatus = null;
            let gatewayChecked = false;

            // Check gateway status when page loads
            document.addEventListener('DOMContentLoaded', function() {
                checkPaymentGatewayStatus();
            });

            function checkPaymentGatewayStatus() {
                // If already checked and valid, return immediately
                if (gatewayChecked && gatewayStatus && gatewayStatus.status === 'success') {
                    return Promise.resolve(true);
                }

                return fetch('check_gateway.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'check_gateway'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        gatewayChecked = true;
                        gatewayStatus = data;

                        if (data.status === 'error' && data.gateway_error) {
                            // Show persistent warning message
                            showGatewayWarning(data.message);
                            disablePaymentButtons();
                            return false;
                        }

                        // Remove any existing warnings
                        removeGatewayWarning();
                        enablePaymentButtons();
                        return true;
                    })
                    .catch(error => {
                        console.error('Error checking gateway status:', error);
                        gatewayChecked = true;
                        gatewayStatus = {
                            status: 'error',
                            message: 'Gateway check failed'
                        };

                        // Show warning but allow payment attempt (fallback)
                        showGatewayWarning('Unable to verify payment gateway. Payments may fail.');
                        return true; // Allow attempt
                    });
            }

            function toggleTVSection() {
                // Only for hybrid mode (phone + optional TV)
                if (currentServiceType === 'tv_only') {
                    return; // Do nothing in TV Only mode
                }

                const tvEnabled = document.getElementById('tv_enabled').checked;
                const tvDetails = document.getElementById('tv_details');
                const tvMacInput = document.getElementById('tv_mac_input');

                if (tvEnabled) {
                    // Show TV section for hybrid mode
                    tvDetails.classList.remove('d-none');
                    tvMacInput.required = true;
                    tvMacInput.disabled = false;
                } else {
                    // Hide TV section
                    tvDetails.classList.add('d-none');
                    tvMacInput.required = false;
                    tvMacInput.value = '';
                }

                updateTotalPrice();
            }

            function formatMacAddress(value) {
                // Remove all non-hex characters
                const cleanValue = value.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();

                // Add colons every 2 characters, max 12 characters
                let formatted = '';
                for (let i = 0; i < Math.min(cleanValue.length, 12); i += 2) {
                    if (i > 0) formatted += ':';
                    formatted += cleanValue.substr(i, 2);
                }

                return formatted;
            }

            function validateMacAddress(mac) {
                return /^([0-9A-F]{2}:){5}([0-9A-F]{2})$/.test(mac);
            }

            // Format TV Only MAC address input
            const tvOnlyMacInput = document.querySelector('input[name="tv_only_mac_address"]');

            if (tvOnlyMacInput) {
                tvOnlyMacInput.addEventListener('input', function(e) {
                    const cursorPosition = e.target.selectionStart;
                    const oldValue = e.target.value;
                    const newValue = formatMacAddress(e.target.value);

                    e.target.value = newValue;

                    let newCursorPosition = cursorPosition;
                    if (newValue.length > oldValue.length && cursorPosition > 0) {
                        newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
                    }

                    e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                });

                tvOnlyMacInput.addEventListener('blur', function(e) {
                    const value = e.target.value;
                    if (value && !validateMacAddress(value)) {
                        e.target.style.borderColor = '#dc3545';
                        e.target.setCustomValidity('Please enter a valid MAC address (e.g., 12:34:56:78:9A:BC)');
                    } else {
                        e.target.style.borderColor = '';
                        e.target.setCustomValidity('');
                    }
                });

                tvOnlyMacInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        e.target.value = formatMacAddress(e.target.value);
                    }, 10);
                });
            }


            function toggleHowToConnect() {
                const element = document.getElementById('howToConnect');
                const chevron = document.getElementById('chevron-icon');
                const bsCollapse = new bootstrap.Collapse(element, {
                    toggle: false
                });

                if (element.classList.contains('show')) {
                    bsCollapse.hide();
                    chevron.classList.remove('transition-transform');
                } else {
                    bsCollapse.show();
                    chevron.classList.add('transition-transform');
                }
            }

            function updateTotalPrice() {
                const selectedAmountElement = document.getElementById('selectedAmount');
                const baseAmount = parseFloat(selectedAmountElement.getAttribute('data-base-price') || selectedAmountElement.value);

                const tvEnabled = document.getElementById('tv_enabled').checked;
                const tvPriceSpan = document.getElementById('tv_price');
                const submitBtn = document.querySelector('#stkForm button[type="submit"]');

                //   console.log('updateTotalPrice - Service Type:', currentServiceType, 'TV Enabled:', tvEnabled);

                if (currentServiceType === 'tv_only') {
                    // TV Only: Single pricing
                    selectedAmountElement.value = baseAmount;
                    submitBtn.innerHTML = `<i class="bi bi-credit-card me-2"></i>Pay KES ${baseAmount.toFixed(0)} (TV Only)`;
                } else if (tvEnabled) {
                    // Phone + TV: Double the price
                    const finalAmount = baseAmount * 2;
                    tvPriceSpan.textContent = baseAmount.toFixed(0);
                    selectedAmountElement.value = finalAmount;
                    submitBtn.innerHTML = `<i class="bi bi-credit-card me-2"></i>Pay KES ${finalAmount.toFixed(0)} (Phone + TV)`;
                } else {
                    // Phone Only: Single pricing
                    tvPriceSpan.textContent = '0';
                    selectedAmountElement.value = baseAmount;
                    submitBtn.innerHTML = '<i class="bi bi-credit-card me-2"></i>Confirm Payment';
                }
            }

            // Enhanced form initialization
            function initializeForms() {
                // console.log('Initializing forms...');

                // Add delay to ensure DOM is ready
                setTimeout(() => {
                    const usernameForm = document.getElementById('usernameForm');
                    //console.log('Username form found:', !!usernameForm);

                    if (usernameForm) {
                        usernameForm.removeEventListener('submit', handleUsernameFormSubmit);
                        usernameForm.addEventListener('submit', handleUsernameFormSubmit);
                        //console.log('Username form listener attached');
                    }

                    // Other forms...
                    const stkForm = document.getElementById('stkForm');
                    if (stkForm) {
                        stkForm.addEventListener('submit', handleStkFormSubmit);
                    }

                    const reconnectForm = document.getElementById('reconnectForm');
                    if (reconnectForm) {
                        reconnectForm.addEventListener('submit', handleReconnectFormSubmit);
                    }

                    const voucherForm = document.getElementById('voucherForm');
                    if (voucherForm) {
                        voucherForm.addEventListener('submit', handleVoucherFormSubmit);
                    }

                    // Input formatting - NO UPPERCASE FOR PASSWORD
                    /*const usernameInput = document.getElementById('username');
                    if (usernameInput) {
                        usernameInput.addEventListener('input', function(e) {
                            if (e.target && e.target.value !== undefined) {
                                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                            }
                        });
                    }*/

                    // Other input handlers...
                    const transactionInput = document.querySelector('input[name="transaction_id"]');
                    if (transactionInput) {
                        transactionInput.addEventListener('input', function(e) {
                            if (e.target && e.target.value !== undefined) {
                                e.target.value = e.target.value.toUpperCase();
                            }
                        });
                    }

                    const vouInput = document.querySelector('input[name="voucher_code"]');
                    if (vouInput) {
                        vouInput.addEventListener('input', function(e) {
                            if (e.target && e.target.value !== undefined) {
                                e.target.value = e.target.value.toUpperCase();
                            }
                        });
                    }

                    // Tab management
                    const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
                    tabButtons.forEach(button => {
                        button.addEventListener('shown.bs.tab', function(e) {
                            const targetTab = e.target.getAttribute('data-bs-target');
                            const firstInput = document.querySelector(`${targetTab} input:not([type="hidden"])`);
                            if (firstInput) {
                                setTimeout(() => firstInput.focus(), 100);
                            }
                        });
                    });

                }, 500); // Wait 500ms
            }

            // Enhanced STK form submission
            function handleStkFormSubmit(e) {
                e.preventDefault();

                // Quick gateway validation using cached result
                if (gatewayChecked && gatewayStatus && gatewayStatus.status === 'error' && gatewayStatus.gateway_error) {
                    showAlert(
                        'Payment Unavailable â',
                        gatewayStatus.message,
                        'error'
                    );
                    return;
                }


                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const loader = document.getElementById('paymentLoader');

                const phone = form.querySelector('input[name="phone_number"]').value;
                const amount = form.querySelector('input[name="amount"]').value;
                const clientIp = form.querySelector('input[name="client_ip"]').value || getStoredValue('client_ip') || '';
                const clientMac = form.querySelector('input[name="client_mac"]').value || getStoredValue('client_mac') || '';

                const tvEnabled = document.getElementById('tv_enabled').checked ? '1' : '0';

                // Extract TV MAC based on service type
                let tvMacAddress = '';
                let tvMacFieldName = '';

                if (currentServiceType === 'tv_only') {
                    const tvOnlyInput = document.getElementById('tv_only_mac_input');
                    tvMacAddress = tvOnlyInput ? tvOnlyInput.value || '' : '';
                    tvMacFieldName = 'tv_only_mac_address';
                } else {
                    tvMacAddress = document.querySelector('input[name="tv_mac_address"]').value || '';
                    tvMacFieldName = 'tv_mac_address';
                }

                // Validate TV MAC if TV is enabled OR if service type is tv_only
                if ((tvEnabled === '1' || currentServiceType === 'tv_only') && !tvMacAddress) {
                    Swal.fire({
                        title: 'TV MAC Address Required',
                        text: 'Please enter your TV MAC address to continue.',
                        icon: 'warning'
                    });
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalButtonText;
                    loader.classList.add('d-none');
                    return;
                }

                // Validate TV MAC if TV is enabled
                if (tvMacAddress) {
                    const macPattern = /^[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}$/;

                    if (!macPattern.test(tvMacAddress)) {
                        console.error('MAC validation FAILED for:', tvMacAddress);
                        Swal.fire({
                            title: 'Invalid TV MAC Address',
                            text: 'Please enter a valid MAC address (e.g., 12:34:56:78:9A:BC)',
                            icon: 'warning'
                        });
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalButtonText;
                        loader.classList.add('d-none');
                        return;
                    }
                }

                // Store current button text for reset
                const originalButtonText = submitBtn.innerHTML;

                // Show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
                loader.classList.remove('d-none');

                // Build base request (without MAC yet)
                const requestBody = new URLSearchParams({
                    action: 'pay',
                    phone_number: phone,
                    amount: amount,
                    client_ip: clientIp,
                    client_mac: clientMac,
                    service_type: currentServiceType
                });

                // === ADD JIUNDIE SUPPORT HERE ===
                const is_jiundie = document.getElementById('service_jiundie')?.checked || false;

                if (is_jiundie && jiundie_selected_package) {
                    requestBody.append('is_jiundie', '1');
                    requestBody.append('jiundie_speed_type', jiundie_selected_package.speed_type);
                    requestBody.append('jiundie_validity', jiundie_selected_package.validity);
                }
                // === END JIUNDIE SUPPORT ===

                // Add TV-related fields based on service type
                if (currentServiceType === 'tv_only') {
                    requestBody.append('tv_enabled', '1');
                    if (tvMacAddress) {
                        requestBody.append('tv_only_mac_address', tvMacAddress);
                    }
                } else {
                    requestBody.append('tv_enabled', tvEnabled);
                    if (tvMacAddress) {
                        requestBody.append('tv_mac_address', tvMacAddress);
                    }
                }

                fetch('index.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: requestBody
                    })
                    .then(response => response.json())
                    .then(result => {
                        // Reset form state
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalButtonText;
                        loader.classList.add('d-none');

                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('stkModal')).hide();

                        if (result.gateway_error) {
                            gatewayChecked = false;
                            checkPaymentGatewayStatus();
                        }

                        if (result.status && result.status.toLowerCase() === 'success') {
                            const paymentData = {
                                phone: phone,
                                amount: amount,
                                timestamp: Date.now(),
                                client_ip: clientIp,
                                client_mac: clientMac,
                                checkout_request_id: result.checkout_request_id
                            };

                            storeValue('paymentData', JSON.stringify(paymentData));

                            storeValue('phone', phone);
                            storeValue('amount', amount);
                            storeValue('service_type', currentServiceType);

                            // === FIX: Auto-close after 2 seconds ===
                            Swal.fire({
                                title: 'STK Push Sent! ð±',
                                text: result.message || 'Check your phone for M-PESA PIN prompt',
                                icon: 'success',
                                timer: 2000,  // Auto-close after 2 seconds
                                timerProgressBar: true,
                                showConfirmButton: false,
                                allowOutsideClick: false
                            }).then(() => {
                                showProcessingScreen();
                                startPaymentCheck(phone, amount, result.checkout_request_id);
                            });
                        } else {
                            Swal.fire({
                                title: 'Payment Failed',
                                text: result.message || 'Payment request failed. Please try again.',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Payment error:', error);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalButtonText;
                        loader.classList.add('d-none');

                        Swal.fire({
                            title: 'Connection Error',
                            text: 'Failed to process payment. Please try again.',
                            icon: 'error'
                        });
                    });
            }

            // UI Helper functions
            function showGatewayWarning(message) {
                // Remove existing warning
                removeGatewayWarning();

                // Create warning banner
                const warningDiv = document.createElement('div');
                warningDiv.id = 'gateway-warning';
                warningDiv.className = 'gateway-warning';
                warningDiv.innerHTML = `
        <div class="warning-content">
            <span class="warning-icon">â ï¸</span>
            <span class="warning-text">${message}</span>
        </div>
    `;

                // Insert at top of page
                document.body.insertBefore(warningDiv, document.body.firstChild);
            }

            function removeGatewayWarning() {
                const existingWarning = document.getElementById('gateway-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
            }

            function disablePaymentButtons() {
                // Disable all payment option buttons
                const paymentOptions = document.querySelectorAll('.package-card-mini, [onclick*="selectPackage"]');
                paymentOptions.forEach(option => {
                    option.style.opacity = '0.5';
                    option.style.pointerEvents = 'none';
                });

                // Add disabled class to indicate unavailability
                paymentOptions.forEach(option => {
                    option.classList.add('payment-disabled');
                });
            }

            function enablePaymentButtons() {
                const paymentOptions = document.querySelectorAll('.package-card-mini, [onclick*="selectPackage"]');
                paymentOptions.forEach(option => {
                    option.style.opacity = '1';
                    option.style.pointerEvents = 'auto';
                    option.classList.remove('payment-disabled');
                });
            }
            // Enhanced reconnect form submission
            function handleReconnectFormSubmit(e) {
                e.preventDefault();

                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const transactionId = form.querySelector('input[name="transaction_id"]').value.trim().toUpperCase();

                if (!transactionId) {
                    showToast('Please enter a Transaction ID, Voucher Code, or Username', 'warning');
                    return;
                }

                // Minimum length check
                if (transactionId.length < 4) {
                    showToast('Please enter at least 4 characters', 'warning');
                    return;
                }

                // Maximum length check
                if (transactionId.length > 20) {
                    showToast('Input too long (max 20 characters)', 'warning');
                    return;
                }

                // Flexible validation patterns
                const patterns = {
                    mpesa: /^[A-Z0-9]{10}$/,
                    voucher: /^[A-Z0-9]{12}$/,
                    mac: /^([0-9A-F]{2}[:-]){5}[0-9A-F]{2}$/i,
                    phone: /^[\+]?[0-9]{10,13}$/,
                    username: /^[A-Z0-9\-_\.]{4,20}$/i
                };

                let isValid = false;
                let inputType = 'unknown';

                if (patterns.mpesa.test(transactionId)) {
                    isValid = true;
                    inputType = 'M-Pesa Transaction';
                } else if (patterns.voucher.test(transactionId)) {
                    isValid = true;
                    inputType = 'Voucher Code';
                } else if (patterns.mac.test(transactionId)) {
                    isValid = true;
                    inputType = 'MAC Address';
                } else if (patterns.phone.test(transactionId)) {
                    isValid = true;
                    inputType = 'Phone Number';
                } else if (patterns.username.test(transactionId)) {
                    isValid = true;
                    inputType = 'Username';
                }

                if (!isValid) {
                    showToast('Invalid format. Please enter a valid Transaction ID, Voucher or Username', 'warning');
                    return;
                }

                //console.log(`Detected input type: ${inputType}`);

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Connecting...';

                form.submit();
            }

            function handleUsernameFormSubmit(e) {
                e.preventDefault();
                //console.log('Username form submitted');

                const form = e.target;
                const submitBtn = document.getElementById('loginBtn');
                const loading = document.getElementById('usernameLoading');

                // Find inputs within the username tab specifically
                const usernameTab = document.getElementById('username-tab');
                let usernameElement = usernameTab ? usernameTab.querySelector('#username') : null;
                let passwordElement = usernameTab ? usernameTab.querySelector('#password') : null;

                // Fallback: find by name within form
                if (!usernameElement) {
                    usernameElement = form.querySelector('input[name="username"]');
                }
                if (!passwordElement) {
                    passwordElement = form.querySelector('input[name="password"]');
                }


                if (!usernameElement || !passwordElement) {
                    showToast('Form elements not found. Please refresh the page.', 'error');
                    return;
                }

                const username = (usernameElement.value || '').trim();
                const password = (passwordElement.value || '').trim();

                //console.log('Username:', username);
                //console.log('Password length:', password.length);
                if (!username || !password) {
                    showToast('Please enter both username and password', 'warning');
                    return;
                }

                // Show loading
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Authenticating...';
                }
                if (loading) {
                    loading.classList.remove('d-none');
                }

                const clientIp = getStoredValue('client_ip') || safeGetItem('client_ip') || '';
                const clientMac = getStoredValue('client_mac') || safeGetItem('client_mac') || '';
                const urlParams = new URLSearchParams(window.location.search);
                const routerId = urlParams.get('router_id') || getStoredValue('router_id') || '';

                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                formData.append('client_ip', clientIp);
                formData.append('client_mac', clientMac);
                formData.append('router_id', routerId);
                formData.append('tenant_uuid', tenantUuid);

                fetch('menareus.php', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.text().then(text => ({
                        status: response.status,
                        text
                    })))
                    .then(({
                        status,
                        text
                    }) => {
                        if (status >= 200 && status < 300) {
                            try {
                                const data = JSON.parse(text);
                                if (data.status === 'success') {
                                    showToast('Login successful! Connecting...', 'success');
                                    setTimeout(() => window.location.href = data.redirect_url || '/', 1000);
                                } else {
                                    showToast(data.message || 'Login failed', 'error');
                                }
                            } catch (e) {
                                // If it's not JSON, it might be the success HTML page
                                document.body.innerHTML = text;
                            }
                        } else if (status === 400) {
                            // Handle 400 errors specifically
                            try {
                                const errorData = JSON.parse(text);
                                showToast(errorData.message || 'Invalid request. Please check your credentials and try again.', 'error');
                            } catch (e) {
                                // If not JSON, show generic message for 400 errors
                                showToast('Invalid request. Please check your credentials and try again.', 'error');
                            }
                        } else if (status === 401) {
                            showToast('Session expired. Please refresh the page and try again.', 'warning');
                        } else if (status === 500) {
                            showToast('Server error. Please try again in a few moments.', 'error');
                        } else {
                            showToast('Connection error. Please check your internet connection and try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Request failed:', error);
                        showToast('Connection error. Please check your internet connection and try again.', 'error');
                    })
                    .finally(() => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Connect to WiFi';
                        }
                        if (loading) {
                            loading.classList.add('d-none');
                        }
                    });
            }

            // Enhanced voucher form submission
            function handleVoucherFormSubmit(e) {
                e.preventDefault();

                const form = e.target;
                const submitBtn = document.getElementById('connectBtn');
                const loading = document.getElementById('loading');
                const voucherCode = document.getElementById('voucher_code').value.toUpperCase().replace(/[^A-Z0-9]/g, '');

                if (!voucherCode || voucherCode.length < 6) {
                    showToast('Please enter a valid voucher code (min 6 characters)', 'warning');
                    return;
                }

                // Show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Connecting...';
                loading.classList.remove('d-none');

                const clientIp = getStoredValue('client_ip') || '';
                const clientMac = getStoredValue('client_mac') || '';
                const urlParams = new URLSearchParams(window.location.search);
                const routerId = urlParams.get('router_id') || '';

                const formData = new FormData();
                formData.append('tenant_uuid', tenantUuid);
                formData.append('voucher_code', voucherCode);
                formData.append('client_ip', clientIp);
                formData.append('client_mac', clientMac);
                formData.append('router_id', routerId);

                fetch('vouchercon.php', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.text().then(text => ({
                        status: response.status,
                        text
                    })))
                    .then(({
                        status,
                        text
                    }) => {
                        if (status >= 200 && status < 300) {
                            document.body.innerHTML = text;
                        } else {
                            try {
                                const json = JSON.parse(text);
                                showToast(json.message || 'Voucher validation failed', 'error');
                            } catch (e) {
                                showToast('Invalid response from server', 'error');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Voucher error:', error);
                        showToast('Network error. Please try again.', 'error');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-wifi me-2"></i>Connect';
                        loading.classList.add('d-none');
                    });
            }

            // Show voucher error with custom toast
            function showVoucherError(message) {
                showToast(message, 'error');
            }

            // Auto-format voucher code input
            document.getElementById('voucher_code').addEventListener('paste', function(e) {
                setTimeout(() => {
                    let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');

                    // Apply same formatting as input handler
                    let formattedValue = value;
                    if (value.length > 4 && value.length <= 8) {
                        formattedValue = value.slice(0, 4) + '-' + value.slice(4);
                    } else if (value.length > 8) {
                        formattedValue = value.slice(0, 4) + '-' + value.slice(4, 8) + '-' + value.slice(8);
                    }

                    e.target.value = formattedValue;
                }, 10);
            });


            // Focus on voucher input when page loads
            window.addEventListener('load', function() {
                document.getElementById('voucher_code').focus();
            });

            // Handle paste events for voucher codes
            document.getElementById('voucher_code').addEventListener('paste', function(e) {
                setTimeout(() => {
                    let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    e.target.value = value;
                }, 10);
            });

            // Custom toast notification
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    console.error('Toast container not found');
                    return;
                }
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
        ${type === 'loading' ? '<i class="fas fa-spinner fa-spin"></i>' : ''}
        <span>${message}</span>
        ${type !== 'loading' ? '<div class="timer-bar"></div>' : ''}
    `;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
                if (type !== 'loading') {
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                }
                return toast;
            }

            // Clear all toasts
            function clearToasts() {
                const toasts = document.querySelectorAll('.toast');
                toasts.forEach(toast => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                });
            }

            // Enhanced package system initialization
            function initializePackageSystem() {
                // Store client information
                var clientIp = '12.10.0.192';
                var clientMac = '9E:85:77:2C:D6:5D';

                if (clientIp && clientMac) {
                    safeSetItem('client_ip', clientIp);
                    safeSetItem('client_mac', clientMac);
                }

                // Start polling
                if (typeof pollingInterval === 'undefined') {
                    var pollingInterval = setInterval(fetchPackages, 30000);
                }
                fetchPackages();

                setInterval(fetchPackages, 30000);
            }

            // Enhanced utility functions
            function getCurrentRouterId() {
                // Try URL parameter first
                try {
                    var urlParams = new URLSearchParams(window.location.search);
                    var routerFromUrl = urlParams.get('router_id');
                    if (routerFromUrl) return routerFromUrl;
                } catch (e) {
                    // URLSearchParams not supported, parse manually
                    var params = window.location.search.substring(1).split('&');
                    for (var i = 0; i < params.length; i++) {
                        var param = params[i].split('=');
                        if (param[0] === 'router_id' && param[1]) {
                            return decodeURIComponent(param[1]);
                        }
                    }
                }

                // Try router select dropdown
                var routerSelect = document.getElementById('router-select');
                if (routerSelect && routerSelect.value) return routerSelect.value;

                // Try hidden input
                var routerInput = document.querySelector('[name="router_id"]');
                if (routerInput && routerInput.value) return routerInput.value;

                // Try default from PHP
                if (typeof defaultRouterId !== 'undefined') return defaultRouterId;

                return null;
            }

            // Enhanced collapse toggle
            function toggleCollapse(id) {
                var element = document.getElementById(id);
                var chevron = document.querySelector('.chevron');

                if (element.classList.contains('show')) {
                    element.classList.remove('show');
                    element.style.maxHeight = '0';
                    element.style.opacity = '0';
                    if (chevron) chevron.classList.remove('rotated');
                } else {
                    element.classList.add('show');
                    element.style.maxHeight = element.scrollHeight + 'px';
                    element.style.opacity = '1';
                    if (chevron) chevron.classList.add('rotated');
                }
            }

            // Enhanced dark mode toggle
            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                var isDarkMode = document.body.classList.contains('dark-mode');
                document.cookie = 'dark-mode=' + isDarkMode + '; path=/';
                var toggleIcon = document.querySelector('.dark-mode-toggle');
                if (toggleIcon) {
                    toggleIcon.textContent = isDarkMode ? 'âï¸' : 'ð';
                    toggleIcon.style.transform = 'scale(0.8) rotate(180deg)';
                    setTimeout(function() {
                        toggleIcon.style.transform = 'scale(1) rotate(0deg)';
                    }, 200);
                }
            }

            // Enhanced modal functions
            function openPopup() {
                var modal = document.getElementById('stkPopup');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.opacity = '0';
                    setTimeout(function() {
                        modal.style.opacity = '1';
                    }, 10);
                }
            }

            function closePopup() {
                var modal = document.getElementById('stkPopup');
                if (modal) {
                    modal.style.opacity = '0';
                    setTimeout(function() {
                        modal.style.display = 'none';
                    }, 300);
                }
            }

            function openManualLoginPopup() {
                var modal = document.getElementById('manualLoginPopup');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.opacity = '0';
                    setTimeout(function() {
                        modal.style.opacity = '1';
                    }, 10);
                }
            }

            function closeManualLoginPopup() {
                var modal = document.getElementById('manualLoginPopup');
                if (modal) {
                    modal.style.opacity = '0';
                    setTimeout(function() {
                        modal.style.display = 'none';
                        var form = document.getElementById('voucherForm');
                        if (form) form.reset();
                    }, 300);
                }
            }

            // Processing screen functions
            function showProcessingScreen() {
                document.getElementById('landing').classList.add('d-none');
                document.getElementById('processing').classList.remove('d-none', 'hidden');

                // Only reset timer if not already set
                if (typeof timeLeft === 'undefined' || timeLeft <= 0) {
                    timeLeft = 30;
                }
                document.getElementById('timer').textContent = timeLeft;
                pollCount = 0;
            }

            function resetToLanding() {
                document.getElementById('processing').classList.add('d-none', 'hidden');
                document.getElementById('landing').classList.remove('d-none');
            }

            let timeLeft = 30;
            let timerInterval;
            let pollCount = 0;
            const maxPolls = 30;

            function startPaymentCheck(phone, amount, checkoutRequestId) {
                const isTimeoutRecovery = checkoutRequestId.startsWith('TIMEOUT-');

                storeValue('phone', phone);
                storeValue('amount', amount);
                storeValue('service_type', currentServiceType);

                // Start timer countdown
                timerInterval = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        handlePaymentTimeout(phone, checkoutRequestId, isTimeoutRecovery);
                    }
                }, 1000);

                // Choose appropriate checking method
                if (isTimeoutRecovery) {
                    checkTimeoutPaymentStatus(phone, checkoutRequestId);
                } else {
                    checkStatus(phone, amount, checkoutRequestId);
                }
            }

            function handlePaymentTimeout(phone, checkoutRequestId, isTimeoutRecovery) {
                removeStoredValue('paymentData');

                if (isTimeoutRecovery) {
                    // For timeout recovery, show extended wait option
                    Swal.fire({
                        title: 'Still Checking Payment',
                        html: `
                <p>We're still verifying your payment status.</p>
                <p>Check your phone for M-Pesa confirmation SMS.</p>
                <button class="btn btn-primary" onclick="extendTimeout('${phone}', '${checkoutRequestId}')">Keep Waiting</button>
                <button class="btn btn-secondary ml-2" onclick="resetToLanding()">Try Again</button>
            `,
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });
                } else {
                    // Normal timeout
                    Swal.fire({
                        title: 'Payment Timed Out',
                        text: 'Your payment was not completed within the allowed time.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        resetToLanding();
                    });
                }
            }

            function extendTimeout(phone, checkoutRequestId) {
                Swal.close();
                showProcessingScreen();
                timeLeft = 60; // Extended timeout
                checkTimeoutPaymentStatus(phone, checkoutRequestId);
            }

            function checkTimeoutPaymentStatus(phone, checkoutRequestId) {
                // For timeout scenarios, we need to check if the payment succeeded
                // and then use the normal connection status checking flow
                const external_ref = checkoutRequestId.replace('TIMEOUT-', '').split('-');
                const external_reference = 'INV-' + external_ref.join('-');

                fetch(`check_payment_status.php?external_reference=${external_reference}&phone=${phone}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'SUCCESS' && data.transaction_id) {
                            // Payment succeeded! Now check connection status using the proper flow
                            clearInterval(timerInterval);
                            removeStoredValue('paymentData');

                            // Convert transaction_id back to checkout_request_id format for check_connection_status.php
                            const synthetic_checkout_id = 'RECOVERY-' + data.transaction_id;

                            // Use the same connection checking flow as normal payments
                            checkConnectionWithTransactionId(data.transaction_id);

                        } else if (data.status === 'QUEUED' || data.status === 'TIMEOUT_PENDING') {
                            // Keep checking
                            setTimeout(() => checkTimeoutPaymentStatus(phone, checkoutRequestId), 3000);
                        } else {
                            // Not found yet, continue checking for a while
                            setTimeout(() => checkTimeoutPaymentStatus(phone, checkoutRequestId), 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Status check failed:', error);
                        setTimeout(() => checkTimeoutPaymentStatus(phone, checkoutRequestId), 5000);
                    });
            }

            function checkConnectionWithTransactionId(transactionId) {
                const checkUrl = `../check_connection_status.php?transaction_id=${encodeURIComponent(transactionId)}&tenant=${encodeURIComponent(tenantUuid)}&phone=${encodeURIComponent(getStoredValue('phone') || '')}&amount=${encodeURIComponent(getStoredValue('amount') || '')}&service_type=${encodeURIComponent(currentServiceType || 'phone')}&t=${Date.now()}`;

                fetch(checkUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'ready') {

                            // --- START:  BLOCK ---

                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else if (data.login_url) {
                                window.location.href = data.login_url;
                            } else if (data.tv_only) {
                                window.location.href = data.login_url;
                            } else {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Payment successful but no connection URL provided',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }

                            // --- END: BLOCK ---

                        } else if (data.status === 'failed') {
                            Swal.fire({
                                title: 'Connection Failed',
                                text: data.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                resetToLanding();
                            });
                        } else {
                            // Still processing, retry after 2 seconds
                            setTimeout(() => checkConnectionWithTransactionId(transactionId), 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Connection check failed:', error);
                        setTimeout(() => checkConnectionWithTransactionId(transactionId), 2000);
                    });
            }

            function checkStatus(phone, amount, checkoutRequestId) {
                const checkUrl = `../check_connection_status.php?checkout_request_id=${encodeURIComponent(checkoutRequestId)}&tenant=${encodeURIComponent(tenantUuid)}&phone=${encodeURIComponent(phone)}&amount=${encodeURIComponent(amount)}&service_type=${encodeURIComponent(currentServiceType || 'phone')}&t=${Date.now()}`;

                fetch(checkUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'ready') {
                            clearInterval(timerInterval);
                            removeStoredValue('paymentData');

                            // Priority 1: redirect_url (for Kopokopo or TV-ONLY)
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            }
                            // Priority 2: login_url (for PayHero phone auto-login)
                            else if (data.login_url) {
                                window.location.href = data.login_url;
                            }
                            // Priority 3: tv_only flag (fallback)
                            else if (data.tv_only) {
                                // This shouldn't happen if redirect_url is set, but handle it
                                window.location.href = data.login_url || data.redirect_url;
                            }
                            // Error: No URL provided
                            else {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Payment successful but no connection URL provided',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                        } else if (data.status === 'failed') {
                            clearInterval(timerInterval);
                            removeStoredValue('paymentData');

                            Swal.fire({
                                title: 'Connection Failed',
                                text: data.message,
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonClass: 'btn btn-gradient'
                            }).then(() => {
                                resetToLanding();
                            });
                        } else {
                            // Still processing, retry after 2 seconds
                            setTimeout(() => checkStatus(phone, amount, checkoutRequestId), 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Status check failed:', error);
                        setTimeout(() => checkStatus(phone, amount, checkoutRequestId), 2000);
                    });
            }

            function checkConnectionWithTransactionId(transactionId) {
                const checkUrl = `../check_connection_status.php?transaction_id=${encodeURIComponent(transactionId)}&tenant=${encodeURIComponent(tenantUuid)}&phone=${encodeURIComponent(getStoredValue('phone') || '')}&amount=${encodeURIComponent(getStoredValue('amount') || '')}&service_type=${encodeURIComponent(currentServiceType || 'phone')}&t=${Date.now()}`;

                fetch(checkUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'ready') {
                            // Priority 1: redirect_url (for Kopokopo or TV-ONLY)
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            }
                            // Priority 2: login_url (for PayHero phone auto-login)
                            else if (data.login_url) {
                                window.location.href = data.login_url;
                            }
                            // Priority 3: tv_only flag (fallback)
                            else if (data.tv_only) {
                                window.location.href = data.login_url || data.redirect_url;
                            }
                            // Error: No URL provided
                            else {
                                console.error('No redirect URL provided');
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Payment successful but no connection URL provided',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                        } else if (data.status === 'failed') {
                            Swal.fire({
                                title: 'Connection Failed',
                                text: data.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                resetToLanding();
                            });
                        } else {
                            // Still processing, retry after 2 seconds
                            setTimeout(() => checkConnectionWithTransactionId(transactionId), 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Connection check failed:', error);
                        setTimeout(() => checkConnectionWithTransactionId(transactionId), 2000);
                    });
            }

            function storeValue(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.warn('Storage failed:', e);
                }
            }

            function getStoredValue(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('Storage retrieval failed:', e);
                    return null;
                }
            }

            function removeStoredValue(key) {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('Storage removal failed:', e);
                }
            }

            // Toast notifications
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();

                const toastHtml = `
                <div class="toast align-items-center border-0" id="${toastId}" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${getToastIcon(type)} me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

                toastContainer.insertAdjacentHTML('beforeend', toastHtml);

                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', () => {
                    toastElement.remove();
                });
            }

            function getToastIcon(type) {
                const icons = {
                    success: 'check-circle-fill',
                    error: 'exclamation-circle-fill',
                    warning: 'exclamation-triangle-fill',
                    info: 'info-circle-fill'
                };
                return icons[type] || 'info-circle-fill';
            }

            // Initialize app
            function initializeApp() {
                // Store client information
                const clientIp = '12.10.0.192';
                const clientMac = '9E:85:77:2C:D6:5D';

                if (clientIp && clientMac) {
                    storeValue('client_ip', clientIp);
                    storeValue('client_mac', clientMac);
                }

                // Detect URL parameters for captive portal
                if (!getStoredValue('client_ip') || !getStoredValue('client_mac')) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const ipFromUrl = urlParams.get('ip') || '';
                    const macFromUrl = urlParams.get('mac') || '';
                    const routerFromUrl = urlParams.get('router_id') || '';

                    if (ipFromUrl) storeValue('client_ip', ipFromUrl);
                    if (macFromUrl) storeValue('client_mac', macFromUrl);
                    if (routerFromUrl) storeValue('router_id', routerFromUrl);
                }

                // Initialize forms
                initializeForms();

                // Handle payment processing state
                const paymentDataStr = getStoredValue('paymentData');
                if (paymentDataStr) {
                    try {
                        const paymentData = JSON.parse(paymentDataStr);
                        const now = Date.now();
                        const oneMinute = 60 * 1000;

                        if (now - paymentData.timestamp <= oneMinute) {
                            showProcessingScreen();
                            startPaymentCheck(paymentData.phone, paymentData.amount, paymentData.checkout_request_id);
                        } else {
                            removeStoredValue('paymentData');
                            resetToLanding();
                        }
                    } catch (e) {
                        console.error('Invalid payment data:', e);
                        removeStoredValue('paymentData');
                        resetToLanding();
                    }
                } else {
                    resetToLanding();
                }

                // Auto-dismiss alerts
                setTimeout(() => {
                    const alerts = document.querySelectorAll('.alert');
                    alerts.forEach(alert => {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    });
                }, 5000);
            }

            // Handle message boxes
            var messageBox = document.getElementById('messageBox');
            if (messageBox) {
                setTimeout(function() {
                    messageBox.style.opacity = '0';
                    messageBox.style.transform = 'translateY(-20px)';
                    setTimeout(function() {
                        if (messageBox.parentNode) {
                            messageBox.parentNode.removeChild(messageBox);
                        }
                    }, 300);
                }, 5000);
            }

            // Initialize collapse states
            var collapseElements = document.querySelectorAll('.collapse');
            for (var i = 0; i < collapseElements.length; i++) {
                collapseElements[i].style.maxHeight = '0';
                collapseElements[i].style.opacity = '0';
                collapseElements[i].style.transition = 'all 0.3s ease';
            }

            // Enhanced modal click-outside-to-close
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    setTimeout(function() {
                        e.target.style.display = 'none';
                    }, 300);
                }
            });

            // Enhanced smooth scrolling
            var smoothScrollLinks = document.querySelectorAll('a[href^="#"]');
            for (var i = 0; i < smoothScrollLinks.length; i++) {
                smoothScrollLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    var targetId = this.getAttribute('href');
                    var target = document.querySelector(targetId);
                    if (target) {
                        if (target.scrollIntoView) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        } else {
                            // Fallback for older browsers
                            var targetTop = target.offsetTop;
                            window.scrollTo(0, targetTop);
                        }
                    }
                });
            }

            (function() {
                'use strict';

                // Check if slider exists
                const sliderWrapper = document.getElementById('adSlider');
                if (!sliderWrapper) return;

                // Configuration from PHP
                const adDuration = 5000;
                const adsCount = 1; // +1 for guide slide

                // State management
                let currentSlide = 0;
                let isPlaying = true;
                let autoPlayInterval = null;
                let slides = null;
                let dots = null;

                // Initialize slider
                function initSlider() {
                    slides = sliderWrapper.querySelectorAll('.ad-slide');
                    if (slides.length === 0) return;

                    // Create navigation dots
                    createDots();

                    // Setup controls
                    setupControls();

                    // Start autoplay
                    startAutoPlay();

                    // Preload images for smooth transitions
                    preloadImages();
                }

                // Create navigation dots
                function createDots() {
                    const dotsContainer = document.getElementById('adSliderDots');
                    if (!dotsContainer) return;

                    dotsContainer.innerHTML = '';

                    for (let i = 0; i < slides.length; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'ad-slider-dot';
                        if (i === 0) dot.classList.add('active');
                        dot.setAttribute('data-slide', i);
                        dot.addEventListener('click', () => goToSlide(i));
                        dotsContainer.appendChild(dot);
                    }

                    dots = dotsContainer.querySelectorAll('.ad-slider-dot');
                }

                // Setup control buttons
                function setupControls() {
                    const controlBtn = document.getElementById('adSliderControl');
                    if (!controlBtn) return;

                    controlBtn.addEventListener('click', togglePlayPause);
                }

                // Toggle play/pause
                function togglePlayPause() {
                    const controlBtn = document.getElementById('adSliderControl');
                    const icon = controlBtn.querySelector('i');

                    if (isPlaying) {
                        stopAutoPlay();
                        icon.className = 'bi bi-play-fill';
                        controlBtn.setAttribute('aria-label', 'Play slider');
                    } else {
                        startAutoPlay();
                        icon.className = 'bi bi-pause-fill';
                        controlBtn.setAttribute('aria-label', 'Pause slider');
                    }

                    isPlaying = !isPlaying;
                }

                // Start autoplay
                function startAutoPlay() {
                    if (autoPlayInterval) return;

                    autoPlayInterval = setInterval(() => {
                        nextSlide();
                    }, adDuration);
                }

                // Stop autoplay
                function stopAutoPlay() {
                    if (autoPlayInterval) {
                        clearInterval(autoPlayInterval);
                        autoPlayInterval = null;
                    }
                }

                // Go to specific slide
                function goToSlide(index) {
                    if (index === currentSlide) return;

                    // Remove active class from current slide and dot
                    slides[currentSlide].classList.remove('active');
                    if (dots && dots[currentSlide]) {
                        dots[currentSlide].classList.remove('active');
                    }

                    // Add active class to new slide and dot
                    currentSlide = index;
                    slides[currentSlide].classList.add('active');
                    if (dots && dots[currentSlide]) {
                        dots[currentSlide].classList.add('active');
                    }

                    // Reset autoplay timer
                    if (isPlaying) {
                        stopAutoPlay();
                        startAutoPlay();
                    }
                }

                // Next slide
                function nextSlide() {
                    const nextIndex = (currentSlide + 1) % slides.length;
                    goToSlide(nextIndex);
                }

                // Previous slide
                function prevSlide() {
                    const prevIndex = (currentSlide - 1 + slides.length) % slides.length;
                    goToSlide(prevIndex);
                }

                // Preload images for smooth transitions
                function preloadImages() {
                    slides.forEach((slide, index) => {
                        if (index === 0) return; // Skip first slide (already visible)

                        const bg = slide.querySelector('.ad-slide-bg');
                        if (!bg) return;

                        const imageUrl = bg.style.backgroundImage.match(/url\(['"]?([^'"]+)['"]?\)/);
                        if (imageUrl && imageUrl[1]) {
                            const img = new Image();
                            img.src = imageUrl[1];
                        }
                    });
                }

                // Pause on hover (optional enhancement)
                function setupHoverPause() {
                    sliderWrapper.addEventListener('mouseenter', () => {
                        if (isPlaying) {
                            stopAutoPlay();
                        }
                    });

                    sliderWrapper.addEventListener('mouseleave', () => {
                        if (isPlaying) {
                            startAutoPlay();
                        }
                    });
                }

                // Cleanup on page unload
                function cleanup() {
                    stopAutoPlay();
                }

                // Visibility API - pause when tab is hidden
                function handleVisibilityChange() {
                    if (document.hidden) {
                        stopAutoPlay();
                    } else if (isPlaying) {
                        startAutoPlay();
                    }
                }

                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initSlider);
                } else {
                    initSlider();
                }

                // Setup additional features
                setupHoverPause();

                // Listen for visibility changes
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // Cleanup on unload
                window.addEventListener('beforeunload', cleanup);

                // Touch swipe support for mobile
                let touchStartX = 0;
                let touchEndX = 0;

                sliderWrapper.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, {
                    passive: true
                });

                sliderWrapper.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, {
                    passive: true
                });

                function handleSwipe() {
                    const swipeThreshold = 50;
                    const diff = touchStartX - touchEndX;

                    if (Math.abs(diff) > swipeThreshold) {
                        if (diff > 0) {
                            nextSlide(); // Swipe left
                        } else {
                            prevSlide(); // Swipe right
                        }
                    }
                }

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    if (e.key === 'ArrowLeft') {
                        prevSlide();
                    } else if (e.key === 'ArrowRight') {
                        nextSlide();
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        togglePlayPause();
                    }
                });

            })();

            // ============================================================================
// MANUAL PAYMENT: Global Variables
// ============================================================================
let manualPaymentRequestId = null;
let manualPaymentPolling = null;
let selectedPackageForManual = null;

// ============================================================================
// MANUAL PAYMENT: Initialize Dropdown & Handlers
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    // Populate package dropdown for manual payment
    populateManualPaymentPackages();
    
    // Monitor manual payment package selection
    const manualPackageSelect = document.getElementById('manual-package-select');
    if (manualPackageSelect) {
        manualPackageSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (selectedOption.value) {
                // Store selected package info
                document.getElementById('manual-package-name').value = selectedOption.dataset.packageName;
                document.getElementById('manual-package-amount').value = selectedOption.value;
                
                selectedPackageForManual = {
                    name: selectedOption.dataset.packageName,
                    price: parseFloat(selectedOption.value),
                    duration: selectedOption.dataset.duration
                };
                
                // Check if form is ready
                checkManualPaymentForm();
            }
        });
    }
    
    // Monitor manual payment inputs
    const manualPhone = document.getElementById('manual-phone');
    const manualMessage = document.getElementById('manual-mpesa-message');
    
    if (manualPhone) {
        manualPhone.addEventListener('input', checkManualPaymentForm);
    }
    
    if (manualMessage) {
        manualMessage.addEventListener('input', checkManualPaymentForm);
    }
    
    // Verify payment button
    const verifyBtn = document.getElementById('verify-manual-payment-btn');
    if (verifyBtn) {
        verifyBtn.addEventListener('click', handleManualPaymentVerification);
    }
});

// ============================================================================
// MANUAL PAYMENT: Populate Package Dropdown
// ============================================================================
function populateManualPaymentPackages() {
    const routerId = getCurrentRouterId();
    const selectElement = document.getElementById('manual-package-select');
    
    if (!selectElement || !routerId) return;
    
    // Fetch packages from server
    fetch('get_packages.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            tenant_id: 130,
            router_id: routerId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.packages.length > 0) {
            // Clear existing options except first
            selectElement.innerHTML = '<option value="">-- Choose Package --</option>';
            
            // Add package options
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.price;
                option.dataset.packageName = pkg.package_name;
                option.dataset.duration = pkg.duration_formatted.display;
                option.textContent = `${pkg.package_name} - KES ${pkg.price} (${pkg.duration_formatted.display})`;
                selectElement.appendChild(option);
            });
        } else {
            selectElement.innerHTML = '<option value="">No packages available</option>';
        }
    })
    .catch(error => {
        console.error('Error loading packages:', error);
        selectElement.innerHTML = '<option value="">Error loading packages</option>';
    });
}

// ============================================================================
// MANUAL PAYMENT: Form Validation
// ============================================================================
function checkManualPaymentForm() {
    const packageAmount = document.getElementById('manual-package-amount')?.value;
    const packageName = document.getElementById('manual-package-name')?.value;
    const phone = document.getElementById('manual-phone')?.value?.trim();
    const message = document.getElementById('manual-mpesa-message')?.value?.trim();
    const verifyBtn = document.getElementById('verify-manual-payment-btn');
    
    if (!verifyBtn) return;
    
    // Validate all fields
    const hasPackage = packageAmount && packageName;
    const hasValidPhone = phone && phone.length >= 10;
    const hasValidMessage = message && message.length >= 10;
    
    const isValid = hasPackage && hasValidPhone && hasValidMessage;
    
    // Enable/disable button
    verifyBtn.disabled = !isValid;
    
    // Visual feedback
    if (isValid) {
        verifyBtn.classList.remove('btn-secondary');
        verifyBtn.classList.add('btn-gradient');
    } else {
        verifyBtn.classList.remove('btn-gradient');
        verifyBtn.classList.add('btn-secondary');
    }
}

// ============================================================================
// HELPER: Copy Payment Number to Clipboard
// ============================================================================
function copyPaymentNumber(number) {
    // Create temporary input
    const tempInput = document.createElement('input');
    tempInput.value = number;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    
    // Show feedback
    const btn = event.target.closest('button');
    if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-success');
        }, 2000);
    }
    
    // Also show toast
    showToast('Copied!', 'Payment number copied to clipboard', 'success');
}

// ============================================================================
// MANUAL PAYMENT: Extract M-PESA Code with Feedback
// ============================================================================
function extractMpesaCode(message) {
    
    if (!message || message.length < 10) {
        console.error('Message too short:', message);
        showToast('Invalid Message', 'Please paste the complete M-PESA SMS message', 'error');
        return null;
    }
    
    // Extract first 10 characters
    const code = message.substring(0, 10).trim().toUpperCase();
    
    // Validate format: 10 alphanumeric characters
    const isValid = /^[A-Z0-9]{10}$/i.test(code);
    
    if (!isValid) {
        console.error('Invalid M-PESA code format:', code);
        showToast('Invalid Code Format', `The M-PESA code "${code}" doesn't look right. Make sure you pasted the complete SMS message starting with the code.`, 'error');
        return null;
    }
    
    console.log('â Extracted M-PESA code:', code);
    showToast('Code Detected', `M-PESA code "${code}" found in message`, 'success');
    return code;
}

// ============================================================================
// MANUAL PAYMENT: Verification Handler with Real-Time Feedback
// ============================================================================
async function handleManualPaymentVerification() {
    const packageName = document.getElementById('manual-package-name').value;
    const amount = document.getElementById('manual-package-amount').value;
    const phone = document.getElementById('manual-phone').value;
    const message = document.getElementById('manual-mpesa-message').value;
    
    // Extract M-PESA code
    showToast('Step 1/4', 'Extracting M-PESA code from message...', 'info');
    const mpesaCode = extractMpesaCode(message);
    
    if (!mpesaCode) {
        return;
    }
    
    // Validate phone
    showToast('Step 2/4', 'Validating phone number...', 'info');
    const phoneRegex = /^(0|254)(7\d{8}|11\d{7})$/;
    const cleanPhone = phone.replace(/\s+/g, '');
    
    if (!phoneRegex.test(cleanPhone)) {
        showToast('Invalid Phone', 'Phone number format is incorrect', 'error');
        return;
    }
    
    console.log('â Phone validated:', cleanPhone);
    
    // Show loading
    showToast('Step 3/4', 'Submitting verification request...', 'info');
    showManualLoading();
    
    try {
        // â CRITICAL FIX: Remove Authorization header, add tenant_id to body
        const response = await fetch('https://meakingwlan.top/api/sms/mpesa/verify/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // â REMOVED: 'Authorization': 'Bearer ...'
            },
            body: JSON.stringify({
                mpesa_code: mpesaCode,
                package_name: packageName,
                amount: parseFloat(amount),
                phone: cleanPhone,
                tenant_id: 130,  // â NOW SENT IN BODY
                router_id: getCurrentRouterId()
            })
        });
        
        const data = await response.json();
        console.log('Verification response:', data);
        
        if (data.success) {
            if (data.status === 'confirmed' && data.voucher_code) {
                showToast('Success!', 'Payment already verified!', 'success');
                showManualSuccess(data.voucher_code);
            } else if (data.status === 'pending') {
                showToast('Step 4/4', 'Verifying your payment...', 'info');
                manualPaymentRequestId = data.request_id;
                startManualPaymentPolling(data.request_id);
            } else if (data.status === 'not_found') {
                showToast('Not Found', 'M-PESA code not found', 'error');
                showManualError('M-PESA code not found. Please verify the code is correct.');
            }
        } else {
            showToast('Request Failed', data.message || 'Verification request failed', 'error');
            showManualError(data.message || 'Verification request failed.');
        }
        
    } catch (error) {
        console.error('Manual payment verification error:', error);
        showToast('Network Error', 'Could not connect to server', 'error');
        showManualError('Network error. Please check your connection.');
        hideManualLoading();
    }
}


// ============================================================================
// MANUAL PAYMENT: Polling with Real-Time Progress Updates
// ============================================================================
function startManualPaymentPolling(requestId) {
    let attempts = 0;
    const maxAttempts = 15;
    let progress = 0;
    const progressBar = document.querySelector('#manual-payment-loading .progress-bar');
    
    showToast('Verifying...', 'Waiting for confirmation...', 'info');
    
    manualPaymentPolling = setInterval(async () => {
        attempts++;
        progress = (attempts / maxAttempts) * 100;
        
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
        
        if (attempts % 3 === 0 && attempts < maxAttempts) {
            const timeLeft = Math.ceil((maxAttempts - attempts) * 2);
            showToast('Still Checking...', `${timeLeft}s remaining`, 'info');
        }
        
        try {
            const response = await fetch(
                `https://meakingwlan.top/api/sms/mpesa/verify/status/${requestId}?tenant_id=130`,
                {
                    // â REMOVED: Authorization header
                }
            );
            
            const data = await response.json();
            console.log(`[Poll ${attempts}/${maxAttempts}]`, data);
            
            if (data.success) {
                if (data.status === 'confirmed' && data.voucher_code) {
                    clearInterval(manualPaymentPolling);
                    showToast('Payment Confirmed! ð', `Voucher: ${data.voucher_code}`, 'success');
                    showManualSuccess(data.voucher_code);
                    playSuccessSound();
                    
                } else if (data.status === 'not_found') {
                    clearInterval(manualPaymentPolling);
                    showToast('Payment Not Found', 'M-PESA code not found', 'error');
                    showManualError('M-PESA code not found.');
                    
                } else if (data.status === 'pending' && attempts >= maxAttempts) {
                    clearInterval(manualPaymentPolling);
                    showToast('Verification Timeout', 'Taking longer than expected', 'warning');
                    showManualError('Verification timeout. Contact support if payment was successful.');
                    startBackgroundPolling(requestId);
                }
            } else {
                if (attempts >= maxAttempts) {
                    clearInterval(manualPaymentPolling);
                    showToast('Verification Failed', data.message, 'error');
                    showManualError(data.message);
                }
            }
            
        } catch (error) {
            console.error('Polling error:', error);
            
            if (attempts >= maxAttempts) {
                clearInterval(manualPaymentPolling);
                showToast('Connection Timeout', 'Could not verify payment', 'error');
                showManualError('Verification timeout.');
            }
        }
        
    }, 2000);
}

// ============================================================================
// BACKGROUND POLLING: MEAKINGWLAN
// ============================================================================
function startBackgroundPolling(requestId) {
    let bgAttempts = 0;
    const maxBgAttempts = 12; // Check for 2 more minutes (12 Ã 10 seconds)
    
    console.log('[Background Polling] Started for request:', requestId);
    
    const bgPolling = setInterval(async () => {
        bgAttempts++;
        
        try {
            // â FIX: Add tenant_id query parameter
            const response = await fetch(
                `https://meakingwlan.top/api/sms/mpesa/verify/status/${requestId}?tenant_id=130`,
                {
                    // No Authorization header needed for public endpoint
                }
            );
            
            const data = await response.json();
            console.log(`[Background Poll ${bgAttempts}/${maxBgAttempts}]`, data);
            
            if (data.success && data.status === 'confirmed' && data.voucher_code) {
                // SUCCESS! Show voucher even after timeout
                clearInterval(bgPolling);
                showToast('Payment Found! ð', 'Your payment was verified', 'success');
                showManualSuccess(data.voucher_code);
                playSuccessSound();
            } else if (bgAttempts >= maxBgAttempts) {
                clearInterval(bgPolling);
                console.log('[Background Polling] Stopped after max attempts');
            }
            
        } catch (error) {
            console.error('[Background Polling] Error:', error);
            if (bgAttempts >= maxBgAttempts) {
                clearInterval(bgPolling);
            }
        }
        
    }, 10000); // Poll every 10 seconds
}

// ============================================================================
// OPTIONAL: Play Success Sound
// ============================================================================
function playSuccessSound() {
    try {
        // Create a simple success beep using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Could not play success sound:', e);
    }
}

// ============================================================================
// MANUAL PAYMENT: 
// ============================================================================
function showManualLoading() {
    document.getElementById('manual-payment-form')?.classList.add('d-none');
    document.getElementById('manual-payment-loading')?.classList.remove('d-none');
    document.getElementById('manual-payment-success')?.classList.add('d-none');
    document.getElementById('manual-payment-error')?.classList.add('d-none');
    
    // Reset progress bar
    const progressBar = document.querySelector('#manual-payment-loading .progress-bar');
    if (progressBar) {
        progressBar.style.width = '0%';
    }
}

function hideManualLoading() {
    document.getElementById('manual-payment-loading')?.classList.add('d-none');
    document.getElementById('manual-payment-form')?.classList.remove('d-none');
}

// ============================================================================
// MANUAL PAYMENT: Enhanced Success Display
// ============================================================================
function showManualSuccess(voucherCode) {
    hideManualLoading();
    
    const successDiv = document.getElementById('manual-payment-success');
    const voucherInput = document.getElementById('manual-voucher-code');
    
    if (successDiv && voucherInput) {
        voucherInput.value = voucherCode;
        successDiv.classList.remove('d-none');
        
        // Auto-scroll to success message
        setTimeout(() => {
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
        
        // Show big success toast
        showToast('Payment Verified! ð', `Your voucher code is: ${voucherCode}`, 'success');
        
        // Auto-fill voucher tab
        const voucherTabInput = document.getElementById('voucher_code');
        if (voucherTabInput) {
            voucherTabInput.value = voucherCode;
            showToast('Auto-Filled', 'Voucher code auto-filled in the Voucher tab below', 'info');
        }
        
        // Highlight voucher tab
        const voucherTab = document.querySelector('[data-bs-target="#voucher"]');
        if (voucherTab) {
            voucherTab.classList.add('pulse-animation');
            setTimeout(() => {
                voucherTab.classList.remove('pulse-animation');
            }, 3000);
        }
    }
}

function showManualError(message) {
    hideManualLoading();
    
    const errorDiv = document.getElementById('manual-payment-error');
    const errorMessage = document.getElementById('manual-error-message');
    
    if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.classList.remove('d-none');
        
        // Auto-scroll to error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Show toast
        showToast('Error', message, 'error');
        
        // Hide error after 10 seconds
        setTimeout(() => {
            errorDiv.classList.add('d-none');
        }, 10000);
    }
}

// ============================================================================
// MANUAL PAYMENT: Copy Voucher Code
// ============================================================================
function copyVoucherCode() {
    const voucherInput = document.getElementById('manual-voucher-code');
    
    if (voucherInput) {
        voucherInput.select();
        document.execCommand('copy');
        
        // Show feedback
        showToast('Copied', 'Voucher code copied to clipboard!', 'success');
        
        // Change button text temporarily
        const copyBtn = event.target.closest('button');
        if (copyBtn) {
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
            }, 2000);
        }
    }
}

// ============================================================================
// HELPER: Get Cookie (for auth token)
// ============================================================================
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
}

// ============================================================================
// HELPER: Show Toast Notification (if you have toast implementation)
// ============================================================================
function showToast(title, message, type = 'info') {
    // If you have Bootstrap toast implementation, use it
    // Otherwise, use a simple alert or console log
    
    const toastContainer = document.getElementById('toastContainer');
    
    if (toastContainer) {
        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
        
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        
        // Remove after hidden
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    } else {
        console.log(`${title}: ${message}`);
    }
}

// ============================================================================
// CLEANUP: Clear polling on page unload
// ============================================================================
window.addEventListener('beforeunload', () => {
    if (manualPaymentPolling) {
        clearInterval(manualPaymentPolling);
    }
});
        </script>
        <script src="auree_today.js"></script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"c0f31c22188b498599b5e999f2663b2c","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>

    </html>
